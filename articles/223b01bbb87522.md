---
title: "LINEãƒœãƒƒãƒˆã‚’Honoã§å®Ÿè£…ã€Cloudflareã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹"
emoji: "ğŸ’¬"
type: "tech"
topics: ["Hono", "Cloudflare", "Cloudflare Pages", "LINE Bot"]
published: true
published_at: 2024-12-01 00:00
publication_name: "moshjp"
---

ã“ã®è¨˜äº‹ã¯MOSH Advent Calendar 2024ã®1æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
https://adventar.org/calendars/9989

LINEã®å•ã„åˆã‚ã›å¯¾å¿œã®çª“å£ã®ä¸€æ¬¡å¯¾å¿œãƒœãƒƒãƒˆã‚’Honoã§å®Ÿè£…ã—ãŸã®ã§ãã®è©±ã‚’ã—ã¾ã™ã€‚

## ãŠå•ã„åˆã‚ã›åŸºç›¤ã«ã¤ã„ã¦

MOSHã§ã¯[ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯](https://channel.io/ja)ã¨ã„ã†é¡§å®¢ç®¡ç†åŠã³ãƒãƒ£ãƒƒãƒˆã‚µãƒãƒ¼ãƒˆã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ã‚„ã‚Šã¨ã‚Šã¯ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯çµŒç”±ã§å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

ä»Šå›ç´¹ä»‹ã™ã‚‹LINEã®å¯¾å¿œã«ã¤ã„ã¦ã‚‚ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯ã®å¤–éƒ¨é€£æºæ©Ÿèƒ½ã‚’ä½¿ã£ã¦LINEã«å±Šã„ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯å†…ã®å—ä¿¡ãƒœãƒƒã‚¯ã‚¹ã«è»¢é€ã—ã¦ã„ã¾ã™ã€‚
https://docs.channel.io/help/ja/categories/7693abeb-%E5%A4%96%E9%83%A8%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E9%80%A3%E6%90%BA

### ä»Šå›ã‚„ã‚ŠãŸã„ã“ã¨

ä»Šå›ã¯LINEã‹ã‚‰ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯ã«æ¥ç¶šã—ã¦ã„ã‚‹éƒ¨åˆ†ã«Webhookã‚’å—ä¿¡ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒŸã¿ã€ãã“ã§ç‹¬è‡ªã®å‡¦ç†ã‚’å…¥ã‚Œã¾ã™ã€‚

å‡¦ç†è‡ªä½“ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€ç‰¹å®šã®ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦é©åˆ‡ãªé¸æŠè‚¢ã‚’è¿”ã—ã¦ã‚ã’ã‚‹(å¯¾å¿œã™ã‚‹é¸æŠè‚¢ãŒãªã‘ã‚Œã°è‡ªå‹•å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡)ã¨ã„ã†æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã ã‘ã§ã™ã€‚

**Before**

```mermaid
sequenceDiagram
  LINE ->> ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯: Webhooké€ä¿¡
  ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯ -->> LINE : è‡ªå‹•å¿œç­”
  ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯ ->> LINE : ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è¿”ä¿¡
```

**After**

```mermaid
sequenceDiagram
  LINE ->> Server: Webhooké€ä¿¡
  Server -->> LINE : è‡ªå‹•å¿œç­” or é¸æŠè‚¢è¡¨ç¤º
  Server ->> ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯ : Webhookè»¢é€
  ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯ ->> LINE : ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è¿”ä¿¡
```

## ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å´ã®è¨­å®š

### Cloudflare

[line/bot-sdk](https://www.npmjs.com/package/@line/bot-sdk)ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯å†…éƒ¨ã§Node.jsã®APIã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã®ã§compatibility_flagsã§ `nodejs_compat` ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
https://developers.cloudflare.com/workers/runtime-apis/nodejs/

```toml:wrangler.toml
name = "linebot"
compatibility_date = "2024-08-29"
compatibility_flags = ["nodejs_compat"]
pages_build_output_dir = "./dist"
```

### LINE Webhook

LINEã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä»Šå›å®Ÿè£…ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Webhookå—ä¿¡ç”¨ã®URLã‚’è¨­å®šã—ã¾ã™ã€‚

LINEå´ã¯1ã¤ã®é€ä¿¡å…ˆã—ã‹è¨­å®šã§ããªã„ã¨ã„ã†ä»•æ§˜ãªã®ã§ã€ãã®ã¾ã¾Webhookã®é€ä¿¡å…ˆã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ã¯ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯ã«LINEã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨˜éŒ²ã•ã‚Œãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
ãã®ãŸã‚ä»Šå›ã¯è‡ªå‹•å¿œç­”ã®å®Ÿè£…ã«åŠ ãˆã¦ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯ã¸Webhookã®å†…å®¹ã‚’è»¢é€ã™ã‚‹å‡¦ç†ã‚‚å®Ÿè£…ã—ã¾ã—ãŸã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆã€œå®Ÿè£…

Honoã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Šã§ã™ãŒ `create-hono` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰cloudflare-pagesã‚’é¸æŠã—ã¾ã™ã€‚(workerså‘ã‘ã‚‚ã‚ã‚‹ã®ã§ä½¿ã„ãŸã„æ–¹ã‚’é¸æŠ)
https://hono.dev/docs/getting-started/cloudflare-pages

```bash
bunx create-hono linebot
create-hono version 0.14.3
âœ” Using target directory â€¦ linebot
? Which template do you want to use?
  aws-lambda
  bun
â¯ cloudflare-pages
  cloudflare-workers
  deno
  fastly
  lambda-edge
(Use arrow keys to reveal more choices)
```

### ç½²åã®æ¤œè¨¼

LINEã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹Webhookã«ã¯ç½²åãŒä»˜ä¸ã•ã‚Œã¦ãŠã‚Šã€æ¤œè¨¼ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
https://developers.line.biz/ja/docs/messaging-api/receiving-messages/#verify-signature

```typescript
const signature = c.req.header("x-line-signature");
const body = await c.req.text();
const envVars = env(c);
if (
  !signature ||
  !validateSignature(body, envVars.LINE_CHANNEL_SECRET, signature)
) {
  // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€å‡¦ç†ã®ä¸­æ–­
}

// æœ¬å‡¦ç†ã®å®Ÿè¡Œ
```

### é¸æŠè‚¢ã‚’è¡¨ç¤ºã™ã‚‹å‡¦ç†

LINEã®ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ã„ã¾ã™ã€‚
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”»é¢ã«æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®é¸æŠè‚¢ã‚’è¡¨ç¤ºã—ã¦ãã‚Œã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¨­å®šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã„ã†ä»•çµ„ã¿ã§ã™ã€‚
https://developers.line.biz/ja/docs/messaging-api/using-quick-reply/

é€šå¸¸ã®ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã®å•ã„åˆã‚ã›ã¨åŒºåˆ¥ã‚’ã™ã‚‹ãŸã‚ã«é€ã£ã¦ã‚‚ã‚‰ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯ `>` ã‚’æ¥é ­è¾ã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```typescript
client.replyMessage({
  replyToken: event.replyToken,
  messages: [{
    type: "text",
    text: "ä»Šæ—¥é£Ÿã¹ãŸã„ã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„",
    quickReply: {
      items: [
        {
          type: "action",
          action: { type: "message", label: "ğŸ£", text: ">å¯¿å¸" },
        },
        {
          type: "action",
          action: { type: "message", label: "ğŸ›", text: ">ã‚«ãƒ¬ãƒ¼" },
        },
        {
          type: "action",
          action: { type: "message", label: "ğŸœ", text: ">ãƒ©ãƒ¼ãƒ¡ãƒ³" },
        }
      ]
    }
  }]
});
```

### ãƒãƒ£ãƒãƒ«ãƒˆãƒ¼ã‚¯ã¸ã®è»¢é€

```typescript
fetch(envVars.CHANNEL_TALK_WEBHOOK_URL, {
  method: "POST",
  headers: {
    "Content-Type": "application/json; charset=utf-8",
    "x-line-signature": signature,
  },
  body,
});
```

### ã‚³ãƒ¼ãƒ‰å…¨ä½“

ä¸Šè¿°ã—ãŸå‡¦ç†ã‚„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãã®ä»–å¿…è¦ãªå‡¦ç†ãªã©ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```typescript
import {
  type WebhookEvent,
  messagingApi,
  validateSignature,
} from "@line/bot-sdk";
import { Hono } from "hono";
import { env } from "hono/adapter";
import { HTTPException } from "hono/http-exception";

type Bindings = {
  LINE_CHANNEL_ACCESS_TOKEN: string;
  LINE_CHANNEL_SECRET: string;
  CHANNEL_TALK_WEBHOOK_URL: string;
};

const app = new Hono<{ Bindings: Bindings }>();

// ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨
app.get("/", (c) => {
  return c.text("OK");
});

app.post("/webhook/line", async (c) => {
  // ç½²åã®æ¤œè¨¼
  const signature = c.req.header("x-line-signature");
  const body = await c.req.text();
  const envVars = env(c);
  if (
    !signature ||
    !validateSignature(body, envVars.LINE_CHANNEL_SECRET, signature)
  ) {
    throw new HTTPException(401, { message: "Unauthorized" });
  }

  // ChannelTalkã¸Webhookã‚’è»¢é€
  await fetch(envVars.CHANNEL_TALK_WEBHOOK_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json; charset=utf-8",
      "x-line-signature": signature,
    },
    body,
  });

  const payload = await c.req.json<{ events: WebhookEvent[] }>();
  const events = payload.events.filter((event) => {
    // ä»Šå›ã®å‡¦ç†ã§å¯¾è±¡ã¨ãªã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥å¤–ã¯é™¤å¤–
    if (event.type !== "message" || event.message.type !== "text") {
      return false;
    }

    // å¯¾è±¡ãƒ¯ãƒ¼ãƒ‰ã«è©²å½“ã—ãªã„ã‚‚ã®ã¯é™¤å¤–
    if (!["ã”é£¯", "ãƒ¡ã‚·"].includes(event.message.text)) {
      return false;
    }

    return true;
  });

  const client = new messagingApi.MessagingApiClient({
    channelAccessToken: envVars.LINE_CHANNEL_ACCESS_TOKEN,
  });
  const promises = events.map((event) =>
    client.replyMessage({
      replyToken: event.replyToken,
      messages: [{
        type: "text",
        text: "ä»Šæ—¥é£Ÿã¹ãŸã„ã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„",
        quickReply: {
          items: [
            {
              type: "action",
              action: { type: "message", label: "ğŸ›", text: ">ã‚«ãƒ¬ãƒ¼" },
            },
            {
              type: "action",
              action: { type: "message", label: "ğŸ£", text: ">å¯¿å¸" },
            },
            {
              type: "action",
              action: { type: "message", label: "ğŸœ", text: ">ãƒ©ãƒ¼ãƒ¡ãƒ³" },
            }
          ]
        }
      }]
    });
  );

  await Promise.allSettled(promises);

  return c.text("OK");
});

export default app;
```

## ã¾ã¨ã‚

Honoã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãŒã‚‰ã‚‚æ§˜ã€…ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¸Šã§ã®å‹•ä½œã‚’æƒ³å®šã•ã‚Œã¦ã„ã‚‹ä½œã‚Šã§ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«æ™‚é–“ãŒã‹ã‹ã‚‰ãšå®Ÿè£…ã«é›†ä¸­ã§ãã‚‹ä½“é¨“ãŒéå¸¸ã«è‰¯ã‹ã£ãŸã§ã™ã€‚

Cloudflareã«é–¢ã—ã¦ã‚‚ãƒã‚¸ãƒˆãƒªé€£æºã«ã‚ˆã‚‹è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚„ä»–ç¤¾ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€é–‹ç™ºè€…ã«å„ªã—ã„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã§ã—ãŸã€‚
